<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeÃ§miÅŸ SÄ±nav SonuÃ§larÄ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d3d6e; --primary-light: #1a5a96; --primary-dark: #0a2f55;
            --secondary-color: #6c757d; --secondary-dark: #5a6268;
            --danger-color: #d9534f; --danger-dark: #c9302c;
            --success-color: #28a745; --success-dark: #1e7e34;
            --info-color: #5bc0de; --info-dark: #31b0d5;
            --background-start: #f4f7fa; --background-end: #e9eff5;
            --card-background: #ffffff;
            --text-color: #333; --text-light: #555;
            --border-color: #e0e0e0; 
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 10px 30px rgba(13, 61, 110, 0.12);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        body, html { font-family: 'Poppins', sans-serif; background-color: var(--background-start); color: var(--text-color); margin: 0; padding: 0; background: linear-gradient(170deg, var(--background-start) 0%, var(--background-end) 100%); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-bottom: 3px solid var(--info-color); }
        .header h1 { margin: 0; font-size: 1.8em; font-weight: 700; }
        
        /* GÄ°RÄ°Åž PANELÄ° */
        .login-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .login-modal-overlay.show { display: flex; }
        .login-panel { background-color: var(--card-background); padding: 35px 45px; border-radius: 16px; box-shadow: var(--shadow-hover); width: 90%; max-width: 420px; text-align: center; border-top: 5px solid var(--primary-color); animation: fadeIn 0.4s ease-out; }
        .login-panel h2 { margin-top: 0; margin-bottom: 25px; color: var(--primary-color); font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-light); }
        .form-group input { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1em; box-sizing: border-box; transition: all 0.2s ease-in-out; }
        .form-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 61, 110, 0.1); outline: none; }
        .login-button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 15px rgba(13, 61, 110, 0.2); }
        .login-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13, 61, 110, 0.3); }
        .login-button:disabled { background: var(--secondary-color); cursor: not-allowed; transform: none; box-shadow: none; }
        .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 15px; display: none; font-weight: 500; }
        
        /* ANA Ä°Ã‡ERÄ°K */
        .main-content { display: none; padding: 20px; animation: fadeIn 0.5s ease-out; }
        .container { width: 100%; max-width: 900px; margin: 0 auto; }
        .user-panel { background-color: var(--card-background); color: var(--primary-dark); padding: 20px; margin-bottom: 25px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border-color); }
        .user-panel h2 { margin: 0; font-weight: 600; }
        .controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .controls button, .controls a { color: white; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .controls button:hover, .controls a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .logout-button { background-color: var(--secondary-color); }
        .logout-button:hover { background-color: var(--secondary-dark); }
        .new-exam-button { background-color: var(--info-color); }
        .new-exam-button:hover { background-color: var(--info-dark); }

        .history-list { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .history-card { background-color: var(--card-background); border-radius: 16px; box-shadow: var(--shadow); padding: 25px; border-left: 5px solid var(--primary-light); transition: transform 0.3s ease, box-shadow 0.3s ease; animation: fadeIn 0.5s ease-out forwards; opacity: 0; animation-delay: calc(var(--card-index) * 0.1s); }
        .history-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .card-header .title { font-size: 1.3em; font-weight: 700; color: var(--primary-color); }
        .card-header .date { font-size: 0.9em; color: var(--text-light); white-space: nowrap; font-weight: 500; }
        .card-body { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .card-stats { display: flex; gap: 15px; font-weight: 500; flex-wrap: wrap; align-items: center; }
        .stat-item { display: flex; align-items: center; gap: 8px; background-color: #f8f9fa; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .stat-item svg { width: 20px; height: 20px; }
        .stat-item span { font-size: 1em; color: var(--text-color); }
        .stat-item span strong { font-size: 1.1em; }
        .stat-item.net { background-color: #eef5ff; border-color: var(--primary-light); }
        .stat-item.net svg { fill: var(--primary-color); }
        .stat-item.net span { color: var(--primary-dark); font-weight: 600; }
        .stat-item.dogru svg { fill: var(--success-color); }
        .stat-item.yanlis svg { fill: var(--danger-color); }
        .stat-item.bos svg { fill: var(--secondary-color); }
        
        .review-button { background: var(--primary-light); color: white; padding: 12px 28px; font-weight: 600; border-radius: 8px; }
        .review-button:hover { background: var(--primary-dark); }
        .status-message { text-align: center; padding: 50px; background-color: var(--card-background); border-radius: 12px; box-shadow: var(--shadow); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-modal" class="login-modal-overlay">
        <div class="login-panel">
            <h2>SÄ±nav GeÃ§miÅŸi Paneli</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">E-posta Adresi</label>
                    <input type="email" id="email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Åžifre</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-button">GiriÅŸ Yap</button>
                <div id="login-error-message" class="error-message"></div>
            </form>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <header class="header"><h1>GeÃ§miÅŸ SÄ±nav SonuÃ§larÄ±nÄ±z</h1></header>
        <div class="container">
            <div class="user-panel">
                <h2 id="user-panel-name"></h2>
            </div>
            <div class="controls">
                <a href="sinav.html" class="new-exam-button">ðŸš€ Yeni SÄ±nava Gir</a>
                <button class="logout-button" id="logout-btn">ðŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
            <div class="history-list" id="history-list-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAvaEaHtTwcuCDBIggJGd4w_nzJQM5UlmY", authDomain: "teacher-adminpanel.firebaseapp.com", projectId: "teacher-adminpanel", storageBucket: "teacher-adminpanel.appspot.com", messagingSenderId: "901735644134", appId: "1:901735644134:web:a6aa575a0754de1333f427" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ICONS = {
            NET: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>`,
            DOGRU: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`,
            YANLIS: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`,
            BOS: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>`
        };

        const ui = {
            loginModal: document.getElementById('login-modal'),
            loginForm: document.getElementById('login-form'),
            loginErrorMessage: document.getElementById('login-error-message'),
            mainContent: document.getElementById('main-content'),
            listContainer: document.getElementById('history-list-container'),
            logoutButton: document.getElementById('logout-btn'),
            userPanelName: document.getElementById('user-panel-name')
        };

        const showStatus = (status, message = '') => {
            if (status === 'loading') ui.listContainer.innerHTML = `<div class="status-message"><div class="loading-spinner"></div><p>SÄ±nav geÃ§miÅŸiniz yÃ¼kleniyor...</p></div>`;
            else if (status === 'empty') ui.listContainer.innerHTML = `<div class="status-message"><h2>GÃ¶rÃ¼ntÃ¼lenecek sÄ±nav geÃ§miÅŸi bulunamadÄ±.</h2><p>Hemen yeni bir sÄ±nava baÅŸlayarak ilk sonucunuzu kaydedebilirsiniz!</p></div>`;
            else if (status === 'error') ui.listContainer.innerHTML = `<div class="status-message"><h2>Bir Hata OluÅŸtu</h2><p>${message}</p></div>`;
        };

        const renderHistory = (exams) => {
            ui.listContainer.innerHTML = '';
            if (exams.length === 0) return showStatus('empty');

            exams.sort((a, b) => b.tarih.seconds - a.tarih.seconds);

            exams.forEach((sonuc, index) => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.style.setProperty('--card-index', index);
                const examDate = new Date(sonuc.tarih.seconds * 1000).toLocaleString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                card.innerHTML = `
                    <div class="card-header">
                        <span class="title">${(sonuc.sinavTuru || 'Bilinmeyen').toUpperCase().replace(/_/g, ' ')} SINAVI</span>
                        <span class="date">${examDate}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-stats">
                            <div class="stat-item net">${ICONS.NET}<span>Net: <strong>${sonuc.netSayisi}</strong></span></div>
                            <div class="stat-item dogru">${ICONS.DOGRU}<span>DoÄŸru: <strong>${sonuc.dogruSayisi}</strong></span></div>
                            <div class="stat-item yanlis">${ICONS.YANLIS}<span>YanlÄ±ÅŸ: <strong>${sonuc.yanlisSayisi}</strong></span></div>
                            <div class="stat-item bos">${ICONS.BOS}<span>BoÅŸ: <strong>${sonuc.bosSayisi}</strong></span></div>
                        </div>
                        <button class="review-button">SorularÄ± Ä°ncele</button>
                    </div>`;
                card.querySelector('.review-button').addEventListener('click', () => {
                    const reviewData = { ...sonuc, tarih: examDate };
                    sessionStorage.setItem('reviewData', JSON.stringify(reviewData));
                    window.location.href = 'sinav.html';
                });
                ui.listContainer.appendChild(card);
            });
        };

        const kullaniciVerisiCek = async (uid) => {
            const userDocRef = doc(db, "kullanicilar", uid);
            try {
                const docSnap = await getDoc(userDocRef);
                return docSnap.exists() ? docSnap.data() : { isim: null, soyisim: null };
            } catch (error) {
                console.error("KullanÄ±cÄ± verisi Ã§ekilirken hata:", error);
                return { isim: null, soyisim: null };
            }
        };

        const fetchUserExams = async (userId) => {
            showStatus('loading');
            try {
                const userExamsRef = collection(db, "kullanicilar", userId, "sinavlar");
                const q = query(userExamsRef, orderBy("tarih", "desc"));
                const querySnapshot = await getDocs(q);
                const exams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory(exams);
            } catch (error) {
                console.error("SÄ±navlar Ã§ekilirken hata:", error);
                showStatus('error', 'SÄ±nav geÃ§miÅŸinizi yÃ¼klerken bir sorunla karÅŸÄ±laÅŸtÄ±k.');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userData = await kullaniciVerisiCek(user.uid);
                const displayName = (userData.isim && userData.soyisim) ? `${userData.isim} ${userData.soyisim}` : user.email;
                ui.userPanelName.textContent = `HoÅŸ Geldin, ${displayName}!`;
                ui.loginModal.classList.remove('show');
                ui.mainContent.style.display = 'block';
                fetchUserExams(user.uid);
            } else {
                ui.mainContent.style.display = 'none';
                ui.loginModal.classList.add('show');
            }
        });
        
        ui.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            ui.loginErrorMessage.style.display = 'none';
            const loginButton = e.target.querySelector('.login-button');
            loginButton.disabled = true;
            loginButton.textContent = 'GiriÅŸ YapÄ±lÄ±yor...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                ui.loginErrorMessage.textContent = 'E-posta veya ÅŸifre hatalÄ±. LÃ¼tfen kontrol ediniz.';
                ui.loginErrorMessage.style.display = 'block';
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'GiriÅŸ Yap';
            }
        });

        ui.logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu:", error);
                alert('Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu.');
            }
        });

    </script>
</body>
</html>